<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGN LEADS USA ‚Äî National Lead Intelligence Map</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c10;
    --panel: #111318;
    --border: #1e2330;
    --accent: #e8291c;
    --glow: rgba(232,41,28,0.4);
    --text: #f0f4ff;
    --muted: #6b7280;
    --heat-0:   #1a1f2e;
    --heat-1:   #2d3748;
    --heat-10:  #1a3a6e;
    --heat-50:  #6d28d9;
    --heat-100: #c0392b;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body { height:100%; overflow-x:hidden; }
  body {
    background: var(--bg);
    font-family: 'Inter', sans-serif;
    color: var(--text);
    min-height: 100vh;
    background-image:
      radial-gradient(ellipse at 20% 0%, rgba(0,40,104,0.15) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 100%, rgba(232,41,28,0.1) 0%, transparent 50%);
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 32px;
    border-bottom: 1px solid var(--border);
    background: rgba(10,12,16,0.95);
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(12px);
  }
  .logo { display: flex; align-items: center; gap: 14px; }
  .logo-icon { width:44px; height:44px; background:var(--accent); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:20px; box-shadow:0 0 20px var(--glow); }
  .logo-text { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; letter-spacing:2px; line-height:1; }
  .logo-sub { font-size:0.7rem; color:var(--muted); letter-spacing:3px; text-transform:uppercase; }
  .header-stats { display:flex; gap:32px; }
  .hstat { text-align:center; }
  .hstat-val { font-family:'Bebas Neue',sans-serif; font-size:2rem; line-height:1; color:var(--accent); }
  .hstat-label { font-size:0.65rem; color:var(--muted); text-transform:uppercase; letter-spacing:2px; }
  .live-badge { display:flex; align-items:center; gap:8px; background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); padding:8px 16px; border-radius:24px; font-size:0.75rem; color:#10b981; font-weight:700; letter-spacing:1px; }
  .live-dot { width:8px; height:8px; background:#10b981; border-radius:50%; animation:pulse-green 2s infinite; }
  @keyframes pulse-green { 0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,0.6)} 50%{box-shadow:0 0 0 6px rgba(16,185,129,0)} }

  /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
  .main { display:grid; grid-template-columns:240px 1fr 240px; min-height:calc(100vh - 73px); }
  .side-panel { background:var(--panel); border-right:1px solid var(--border); padding:24px 16px; }
  .side-panel.right { border-right:none; border-left:1px solid var(--border); }
  .panel-title { font-family:'Bebas Neue',sans-serif; font-size:0.95rem; letter-spacing:3px; color:var(--muted); margin-bottom:16px; padding-bottom:8px; border-bottom:1px solid var(--border); }

  /* Legend */
  .legend-item { display:flex; align-items:center; gap:12px; margin:10px 0; font-size:0.82rem; }
  .legend-dot { width:14px; height:14px; border-radius:3px; flex-shrink:0; }
  .legend-label { color:#c0c8d8; }
  .legend-count { margin-left:auto; color:var(--muted); font-size:0.75rem; }

  /* Top States */
  .top-state-item { display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:8px; margin:6px 0; cursor:pointer; transition:background 0.2s; font-size:0.82rem; }
  .top-state-item:hover { background:rgba(255,255,255,0.05); }
  .top-state-rank { font-family:'Bebas Neue',sans-serif; font-size:1rem; color:var(--muted); width:20px; }
  .top-state-name { flex:1; font-weight:600; }
  .top-state-leads { background:rgba(232,41,28,0.15); color:var(--accent); padding:2px 8px; border-radius:12px; font-size:0.75rem; font-weight:700; }

  /* Activity */
  .activity-item { display:flex; gap:8px; padding:8px 0; border-bottom:1px solid var(--border); font-size:0.78rem; }
  .activity-dot { width:8px; height:8px; border-radius:50%; margin-top:4px; flex-shrink:0; }
  .activity-text { color:#a0aec0; line-height:1.4; }
  .activity-time { color:var(--muted); font-size:0.7rem; margin-top:2px; }

  /* ‚îÄ‚îÄ‚îÄ MAP AREA ‚îÄ‚îÄ‚îÄ */
  .map-area { padding:28px 32px; display:flex; flex-direction:column; align-items:center; }
  .map-title-row { text-align:center; margin-bottom:20px; }
  .map-title-row h2 { font-family:'Bebas Neue',sans-serif; font-size:2.4rem; letter-spacing:4px; line-height:1; }
  .map-title-row p { color:var(--muted); font-size:0.8rem; letter-spacing:2px; text-transform:uppercase; margin-top:4px; }
  #map-container { width:100%; max-width:880px; }

  /* ‚îÄ‚îÄ‚îÄ D3 MAP STYLES ‚îÄ‚îÄ‚îÄ */
  .state-path {
    stroke: #0d1017;
    stroke-width: 0.8px;
    cursor: pointer;
    transition: fill 0.2s ease, filter 0.2s ease;
  }
  .state-path:hover {
    filter: brightness(1.5);
    stroke: rgba(255,255,255,0.5);
    stroke-width: 1.5px;
  }
  /* Heat tiers applied via JS */
  .tier-0   { fill: var(--heat-0); }
  .tier-1   { fill: var(--heat-1); }
  .tier-10  { fill: var(--heat-10); }
  .tier-50  { fill: var(--heat-50); }
  .tier-100 { fill: var(--heat-100); }

  .state-label { font-family:'Inter',sans-serif; font-weight:700; fill:rgba(255,255,255,0.55); pointer-events:none; font-size:7px; }

  /* ‚îÄ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ */
  #tooltip {
    position:fixed; background:rgba(10,12,16,0.97); border:1px solid var(--border); border-radius:12px;
    padding:18px 22px; pointer-events:none; opacity:0; transition:opacity 0.15s; z-index:1000;
    min-width:200px; backdrop-filter:blur(20px); box-shadow:0 20px 60px rgba(0,0,0,0.7),0 0 0 1px rgba(255,255,255,0.05);
    transform:translate(-50%,-120%);
  }
  #tooltip.visible { opacity:1; }
  .tt-state { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:2px; margin-bottom:8px; }
  .tt-leads { font-size:2rem; font-weight:900; color:var(--accent); line-height:1; }
  .tt-sub { font-size:0.75rem; color:var(--muted); margin-top:2px; }
  .tt-status { margin-top:10px; font-size:0.75rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; }
  .tt-status.active { color:#10b981; }
  .tt-status.coming { color:var(--muted); }
  .tt-click { font-size:0.7rem; color:#4a90e2; margin-top:6px; }

  /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
  #modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter:blur(6px); z-index:2000; display:none; align-items:center; justify-content:center; }
  #modal-overlay.visible { display:flex; }
  .modal { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:40px; max-width:460px; width:90%; text-align:center; position:relative; box-shadow:0 40px 100px rgba(0,0,0,0.8); }
  .modal-icon { font-size:3rem; margin-bottom:16px; }
  .modal-title { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:3px; color:var(--accent); margin-bottom:8px; }
  .modal-state { font-family:'Bebas Neue',sans-serif; font-size:1.2rem; letter-spacing:2px; color:var(--muted); margin-bottom:16px; }
  .modal p { font-size:0.9rem; color:#a0aec0; line-height:1.7; margin-bottom:24px; }
  .modal-btn { background:linear-gradient(135deg,var(--accent),#a00820); color:white; border:none; padding:14px 32px; border-radius:8px; font-weight:800; font-size:0.9rem; cursor:pointer; letter-spacing:1px; text-transform:uppercase; transition:all 0.2s; margin:6px; display:inline-block; }
  .modal-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px var(--glow); }
  .modal-btn.secondary { background:transparent; border:1px solid var(--border); color:var(--muted); }
  .modal-close { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--muted); font-size:1.4rem; cursor:pointer; }
  .modal-close:hover { color:var(--text); }

  /* Sync bar */
  .sync-bar { width:100%; max-width:880px; display:flex; align-items:center; justify-content:space-between; margin-top:12px; padding:8px 16px; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:8px; font-size:0.75rem; color:var(--muted); }
  .sync-bar span { display:flex; align-items:center; gap:6px; }
  .sync-spinner { width:10px; height:10px; border:1.5px solid var(--muted); border-top-color:#10b981; border-radius:50%; animation:spin 1.5s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* Quick stats */
  .qstat-row { display:flex; justify-content:space-between; border-bottom:1px solid var(--border); padding:6px 0; font-size:0.82rem; color:#a0aec0; line-height:2; }

  @media (max-width:900px) {
    .main { grid-template-columns:1fr; }
    .side-panel { display:none; }
    header { padding:12px 16px; }
    .header-stats { gap:16px; }
    .hstat-val { font-size:1.4rem; }
    .map-area { padding:16px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üó∫Ô∏è</div>
    <div>
      <div class="logo-text">Sign Leads USA</div>
      <div class="logo-sub">National Intelligence Map</div>
    </div>
  </div>
  <div class="header-stats">
    <div class="hstat"><div class="hstat-val" id="stat-total-leads">‚Äî</div><div class="hstat-label">Total Leads</div></div>
    <div class="hstat"><div class="hstat-val" id="stat-active-states">‚Äî</div><div class="hstat-label">Active States</div></div>
    <div class="hstat"><div class="hstat-val" id="stat-revenue">‚Äî</div><div class="hstat-label">Est. Revenue</div></div>
  </div>
  <div class="live-badge"><div class="live-dot"></div>LIVE SYNC</div>
</header>

<div class="main">

  <!-- LEFT PANEL -->
  <div class="side-panel">
    <div class="panel-title">HEAT MAP LEGEND</div>
    <div class="legend-item"><div class="legend-dot" style="background:#c0392b;box-shadow:0 0 8px rgba(192,57,43,0.5)"></div><div class="legend-label">100+ Leads</div><div class="legend-count" id="leg-100">0 states</div></div>
    <div class="legend-item"><div class="legend-dot" style="background:#6d28d9;box-shadow:0 0 8px rgba(109,40,217,0.5)"></div><div class="legend-label">50‚Äì99 Leads</div><div class="legend-count" id="leg-50">0 states</div></div>
    <div class="legend-item"><div class="legend-dot" style="background:#1a3a6e"></div><div class="legend-label">10‚Äì49 Leads</div><div class="legend-count" id="leg-10">0 states</div></div>
    <div class="legend-item"><div class="legend-dot" style="background:#2d3748"></div><div class="legend-label">1‚Äì9 Leads</div><div class="legend-count" id="leg-1">0 states</div></div>
    <div class="legend-item"><div class="legend-dot" style="background:#1a1f2e;border:1px solid #2d3748"></div><div class="legend-label">Coming Soon</div><div class="legend-count" id="leg-0">0 states</div></div>
    <div class="panel-title" style="margin-top:28px">TOP STATES</div>
    <div id="top-states-list"></div>
  </div>

  <!-- MAP CENTER -->
  <div class="map-area">
    <div class="map-title-row">
      <h2>SELECT YOUR STATE</h2>
      <p>Click any state to access its lead database</p>
    </div>
    <div id="map-container">
      <svg id="usmap" viewBox="0 0 960 600" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;filter:drop-shadow(0 20px 60px rgba(0,0,0,0.6))">
        <g id="states-group"></g>
        <g id="labels-group" pointer-events="none"></g>
      </svg>
    </div>
    <div class="sync-bar">
      <span><div class="sync-spinner"></div> Syncing with state pages‚Ä¶</span>
      <span id="last-updated">Last updated: just now</span>
      <span id="sync-status" style="color:#10b981">‚úì All systems live</span>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="side-panel right">
    <div class="panel-title">RECENT ACTIVITY</div>
    <div id="activity-feed"></div>
    <div class="panel-title" style="margin-top:28px">QUICK STATS</div>
    <div class="qstat-row"><span>States Online</span><span id="qs-online" style="color:#10b981;font-weight:700">‚Äî</span></div>
    <div class="qstat-row"><span>Hot Leads üî•</span><span id="qs-hot" style="color:var(--accent);font-weight:700">‚Äî</span></div>
    <div class="qstat-row"><span>Warm Leads ‚ö°</span><span id="qs-warm" style="color:#f59e0b;font-weight:700">‚Äî</span></div>
    <div class="qstat-row" style="border-bottom:none"><span>Revenue Potential</span><span id="qs-rev" style="color:#10b981;font-weight:700">‚Äî</span></div>
  </div>
</div>

<!-- TOOLTIP -->
<div id="tooltip">
  <div class="tt-state" id="tt-state">Texas</div>
  <div class="tt-leads" id="tt-leads">250+</div>
  <div class="tt-sub">Sign Leads</div>
  <div class="tt-status active" id="tt-status">‚óè Active Database</div>
  <div class="tt-click" id="tt-click">Click to access leads ‚Üí</div>
</div>

<!-- MODAL -->
<div id="modal-overlay">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-icon">üîí</div>
    <div class="modal-title">PREMIUM ACCESS</div>
    <div class="modal-state" id="modal-state-name">‚Äî STATE ‚Äî</div>
    <p>This state's lead database is not yet available. Unlock <strong>premium access</strong> to get verified sign leads, contact info, and revenue estimates for this market.</p>
    <button class="modal-btn" onclick="closeModal()">üîî Request Early Access</button><br>
    <button class="modal-btn secondary" onclick="closeModal()">Close</button>
  </div>
</div>

<!-- D3 v7 + TopoJSON -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURATION ‚Äî add your state pages here
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STATE_PAGES = {
  'TX': 'texas-sign-leads.html',
  'FL': 'florida-sign-leads.html',
  'CA': 'california-sign-leads.html',
  'NY': 'new-york-sign-leads.html',
  'WY': 'wyoming-sign-leads.html',
};

const STORAGE_KEY = 'signleads_state_data';

const DEFAULT_STATE_DATA = {
  TX: { leads: 250, hot: 180, warm: 70, revenue: '$18.4M' },
};

const STATE_NAMES = {
  AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',CA:'California',
  CO:'Colorado',CT:'Connecticut',DE:'Delaware',FL:'Florida',GA:'Georgia',
  HI:'Hawaii',ID:'Idaho',IL:'Illinois',IN:'Indiana',IA:'Iowa',KS:'Kansas',
  KY:'Kentucky',LA:'Louisiana',ME:'Maine',MD:'Maryland',MA:'Massachusetts',
  MI:'Michigan',MN:'Minnesota',MS:'Mississippi',MO:'Missouri',MT:'Montana',
  NE:'Nebraska',NV:'Nevada',NH:'New Hampshire',NJ:'New Jersey',NM:'New Mexico',
  NY:'New York',NC:'North Carolina',ND:'North Dakota',OH:'Ohio',OK:'Oklahoma',
  OR:'Oregon',PA:'Pennsylvania',RI:'Rhode Island',SC:'South Carolina',
  SD:'South Dakota',TN:'Tennessee',TX:'Texas',UT:'Utah',VT:'Vermont',
  VA:'Virginia',WA:'Washington',WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming'
};

// FIPS ‚Üí abbr lookup
const FIPS_TO_ABBR = {
  "01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT","10":"DE",
  "12":"FL","13":"GA","15":"HI","16":"ID","17":"IL","18":"IN","19":"IA","20":"KS",
  "21":"KY","22":"LA","23":"ME","24":"MD","25":"MA","26":"MI","27":"MN","28":"MS",
  "29":"MO","30":"MT","31":"NE","32":"NV","33":"NH","34":"NJ","35":"NM","36":"NY",
  "37":"NC","38":"ND","39":"OH","40":"OK","41":"OR","42":"PA","44":"RI","45":"SC",
  "46":"SD","47":"TN","48":"TX","49":"UT","50":"VT","51":"VA","53":"WA","54":"WV",
  "55":"WI","56":"WY"
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HEAT TIER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTier(leads) {
  if (leads >= 100) return '100';
  if (leads >= 50)  return '50';
  if (leads >= 10)  return '10';
  if (leads >= 1)   return '1';
  return '0';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadStateData() {
  try {
    const stored = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    return Object.assign({}, DEFAULT_STATE_DATA, stored);
  } catch(e) {
    return Object.assign({}, DEFAULT_STATE_DATA);
  }
}

let stateData = {};
let mapBuilt = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD MAP WITH D3 + TopoJSON
// Fetches the official US Atlas TopoJSON from CDN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buildMap() {
  const us = await d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json');

  const width = 960, height = 600;
  const projection = d3.geoAlbersUsa().scale(1300).translate([width / 2, height / 2]);
  const path = d3.geoPath().projection(projection);

  const states = topojson.feature(us, us.objects.states);
  const borders = topojson.mesh(us, us.objects.states, (a, b) => a !== b);

  const g = d3.select('#states-group');
  const labels = d3.select('#labels-group');

  // Draw state fills
  g.selectAll('path.state-path')
    .data(states.features)
    .enter()
    .append('path')
    .attr('class', 'state-path tier-0')
    .attr('d', path)
    .attr('data-fips', d => d.id)
    .attr('data-state', d => FIPS_TO_ABBR[String(d.id).padStart(2,'0')] || '')
    .attr('data-name', d => STATE_NAMES[FIPS_TO_ABBR[String(d.id).padStart(2,'0')]] || '')
    .on('mouseenter', function(event, d) {
      const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')] || '';
      const info = stateData[abbr] || { leads: 0 };
      const hasPage = !!STATE_PAGES[abbr];

      document.getElementById('tt-state').textContent = (STATE_NAMES[abbr] || abbr).toUpperCase();
      document.getElementById('tt-leads').textContent = info.leads > 0 ? info.leads + '+' : '0';

      const statusEl = document.getElementById('tt-status');
      const clickEl  = document.getElementById('tt-click');
      if (hasPage && info.leads > 0) {
        statusEl.textContent = '‚óè Active Database';
        statusEl.className = 'tt-status active';
        clickEl.textContent = 'Click to access leads ‚Üí';
      } else if (hasPage) {
        statusEl.textContent = '‚óè Page Online';
        statusEl.className = 'tt-status active';
        clickEl.textContent = 'Click to open ‚Üí';
      } else {
        statusEl.textContent = '‚óå Coming Soon';
        statusEl.className = 'tt-status coming';
        clickEl.textContent = 'Premium access required';
      }
      document.getElementById('tooltip').classList.add('visible');
      moveTooltip(event);
    })
    .on('mousemove', function(event) { moveTooltip(event); })
    .on('mouseleave', function() { document.getElementById('tooltip').classList.remove('visible'); })
    .on('click', function(event, d) {
      const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')] || '';
      handleStateClick(abbr);
    });

  // Draw inner borders (slightly darker line between states)
  g.append('path')
    .datum(borders)
    .attr('fill', 'none')
    .attr('stroke', '#0d1017')
    .attr('stroke-width', 0.5)
    .attr('d', path)
    .attr('pointer-events', 'none');

  // Draw abbreviation labels at centroid
  labels.selectAll('text')
    .data(states.features)
    .enter()
    .append('text')
    .attr('class', 'state-label')
    .attr('text-anchor', 'middle')
    .attr('dominant-baseline', 'middle')
    .attr('transform', d => {
      const c = path.centroid(d);
      return `translate(${c[0]},${c[1]})`;
    })
    .attr('font-size', d => {
      const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')] || '';
      // Tiny states get a small label
      const tiny = ['CT','DE','RI','NJ','NH','VT','MA','MD'];
      return tiny.includes(abbr) ? '5' : '8';
    })
    .text(d => FIPS_TO_ABBR[String(d.id).padStart(2,'0')] || '');

  mapBuilt = true;
  applyHeatMap();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPLY HEAT MAP COLORS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyHeatMap() {
  if (!mapBuilt) return;
  stateData = loadStateData();

  d3.selectAll('.state-path').each(function() {
    const abbr = this.getAttribute('data-state');
    const leads = (stateData[abbr] || {}).leads || 0;
    this.className.baseVal = `state-path tier-${getTier(leads)}`;
  });

  updateStats();
  updateSidePanels();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS + PANELS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStats() {
  let totalLeads = 0, activeStates = 0, totalRev = 0, hot = 0, warm = 0;
  Object.values(stateData).forEach(d => {
    if (d.leads > 0) { totalLeads += d.leads; activeStates++; }
    if (d.hot)  hot  += d.hot;
    if (d.warm) warm += d.warm;
    if (d.revenue) { const m = d.revenue.match(/([\d.]+)M/); if(m) totalRev += parseFloat(m[1]); }
  });
  document.getElementById('stat-total-leads').textContent = totalLeads.toLocaleString();
  document.getElementById('stat-active-states').textContent = activeStates;
  document.getElementById('stat-revenue').textContent = totalRev > 0 ? '$' + totalRev.toFixed(1) + 'M+' : '‚Äî';
  document.getElementById('qs-online').textContent = activeStates;
  document.getElementById('qs-hot').textContent = hot || '‚Äî';
  document.getElementById('qs-warm').textContent = warm || '‚Äî';
  document.getElementById('qs-rev').textContent = totalRev > 0 ? '$' + totalRev.toFixed(1) + 'M' : '‚Äî';
}

function updateSidePanels() {
  // Legend tier counts (count all 50 states)
  const allAbbrs = Object.values(FIPS_TO_ABBR);
  const counts = {'0':0,'1':0,'10':0,'50':0,'100':0};
  allAbbrs.forEach(abbr => {
    const leads = (stateData[abbr] || {}).leads || 0;
    counts[getTier(leads)]++;
  });
  document.getElementById('leg-100').textContent = counts['100'] + ' states';
  document.getElementById('leg-50').textContent  = counts['50']  + ' states';
  document.getElementById('leg-10').textContent  = counts['10']  + ' states';
  document.getElementById('leg-1').textContent   = counts['1']   + ' states';
  document.getElementById('leg-0').textContent   = counts['0']   + ' states';

  // Top states
  const sorted = Object.entries(stateData).filter(([,d]) => d.leads > 0).sort((a,b) => b[1].leads - a[1].leads).slice(0,8);
  document.getElementById('top-states-list').innerHTML = sorted.map(([abbr, d], i) => `
    <div class="top-state-item" onclick="handleStateClick('${abbr}')">
      <div class="top-state-rank">${i+1}</div>
      <div class="top-state-name">${STATE_NAMES[abbr] || abbr}</div>
      <div class="top-state-leads">${d.leads}</div>
    </div>`).join('');

  // Activity feed
  const items = [
    ...Object.entries(stateData).filter(([,d]) => d.leads > 0).map(([abbr, d]) => ({ color:'#10b981', text:`${STATE_NAMES[abbr]} synced ‚Äî ${d.leads} leads`, time:'live' })),
    { color:'#f59e0b', text:'New state page deploying‚Ä¶', time:'‚Äî' },
    { color:'#4a90e2', text:'Lead count updated in TX', time:'just now' },
    { color:'#10b981', text:'Map auto-refreshing every 5s', time:'always' },
  ].slice(0,8);
  document.getElementById('activity-feed').innerHTML = items.map(a => `
    <div class="activity-item">
      <div class="activity-dot" style="background:${a.color}"></div>
      <div><div class="activity-text">${a.text}</div><div class="activity-time">${a.time}</div></div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOOLTIP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function moveTooltip(event) {
  const tip = document.getElementById('tooltip');
  tip.style.left = event.clientX + 'px';
  tip.style.top  = event.clientY + 'px';
  tip.style.transform = 'translate(-50%, calc(-100% - 16px))';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLICK HANDLER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleStateClick(abbr) {
  if (!abbr) return;
  const page = STATE_PAGES[abbr];
  if (page) {
    window.location.href = page;
  } else {
    document.getElementById('modal-state-name').textContent = '‚Äî ' + (STATE_NAMES[abbr] || abbr).toUpperCase() + ' ‚Äî';
    document.getElementById('modal-overlay').classList.add('visible');
  }
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('visible'); }
document.getElementById('modal-overlay').addEventListener('click', e => { if (e.target === document.getElementById('modal-overlay')) closeModal(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SYNC LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
setInterval(() => {
  applyHeatMap();
  document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
}, 5000);

window.addEventListener('storage', e => {
  if (e.key === STORAGE_KEY) {
    applyHeatMap();
    document.getElementById('sync-status').textContent = '‚ö° Updated';
    setTimeout(() => { document.getElementById('sync-status').textContent = '‚úì All systems live'; }, 2000);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
buildMap().catch(err => {
  // Fallback message if CDN is unavailable
  document.getElementById('map-container').innerHTML = `
    <div style="text-align:center;padding:60px;color:var(--muted);">
      <div style="font-size:2rem;margin-bottom:16px;">üó∫Ô∏è</div>
      <p>Map requires an internet connection to load geographic data.</p>
      <p style="margin-top:8px;font-size:0.8rem;">Open this file in a browser with internet access.</p>
    </div>`;
});
</script>
</body>
</html>
